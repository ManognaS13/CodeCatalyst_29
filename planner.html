<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ECHOES OF EFFORTS - Study Plan</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <nav class="navbar" role="navigation" aria-label="Main navigation">
    <div class="nav-brand">
      <img src="assets/logo.jpg" alt="ECHOES OF EFFORTS Logo" class="nav-logo">
      <span>ECHOES OF EFFORTS</span>
    </div>
    <div class="nav-links">
      <a href="index.html" class="nav-link"><i class="fas fa-home" aria-hidden="true"></i> Home</a>
      <a href="planner.html" class="nav-link active" aria-current="page"><i class="fas fa-calendar-alt" aria-hidden="true"></i> Planner</a>
    </div>
    <div class="nav-actions" id="navActions">
      <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" aria-label="Toggle dark mode">
        <i class="fas fa-moon" id="themeIcon"></i>
      </button>
    </div>
  </nav>
        </form>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="planner-header">
    <h1>5-Day Study Planner</h1>
    <p>Organize your preparation with a simple plan</p>
  </header>

  <!-- Main Content -->
  <main>
    <!-- Progress Overview -->
    <section class="progress-section">
      <div class="section-header">
        <h2>Your Progress Overview</h2>
        <p>Track your learning journey and weekly achievements</p>
      </div>
      <div class="progress-container">
        <div class="chart-container">
          <canvas id="progressChart"></canvas>
        </div>
        <div class="stats-container">
          <div class="stat-card">
            <i class="fas fa-book-open"></i>
            <h3>Topics Completed</h3>
            <p id="topicsCompleted">0</p>
          </div>
          <div class="stat-card">
            <i class="fas fa-chart-line"></i>
            <h3>Weekly Progress</h3>
            <p id="weeklyProgress">0%</p>
          </div>
          <div class="stat-card">
            <i class="fas fa-trophy"></i>
            <h3>Test Score</h3>
            <p id="avgTestScore">0%</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Weekly Topic Planner -->
    <section class="weekly-planner-section">
      <div class="section-header">
        <h2>Weekly Learning Plan</h2>
        <p>Your personalized study roadmap</p>
      </div>
      <div id="weeklyPlanGrid" class="weekly-plan-grid">
        <!-- Weekly plans will be populated here -->
      </div>
    </section>

    <!-- Study Resources -->
    <section class="intro">
      <div class="section-header">
        <h2>Study Schedule</h2>
        <p>Your daily learning path</p>
      </div>
      <table>
        <tr>
          <th>Day</th>
          <th>Subjects & Topics</th>
        </tr>
        <tr>
          <td>Day 1</td>
          <td>Physics – Motion and Laws</td>
        </tr>
        <tr>
          <td>Day 2</td>
          <td>Chemistry – Atomic Structure</td>
        </tr>
        <tr>
          <td>Day 3</td>
          <td>Math – Trigonometry & Algebra</td>
        </tr>
        <tr>
          <td>Day 4</td>
          <td>Biology – Human Anatomy</td>
        </tr>
        <tr>
          <td>Day 5</td>
          <td>Revision + Practice Tests</td>
        </tr>
      </table>
    </section>

    <section class="planner-controls">
      <div class="exam-select">
        <label for="examSelect">Select Your Exam:</label>
        <select id="examSelect" onchange="loadPlannerContent()">
          <option value="KCET">KCET</option>
          <option value="NEET">NEET</option>
          <option value="JEE">JEE</option>
          <option value="PUC">PUC</option>
          <option value="10th">10th Board</option>
        </select>
      </div>
      <div class="timer-controls">
        <span id="timerDisplay">00:00:00</span>
        <button onclick="toggleTimer()" class="ai-button" id="timerBtn">Start Timer</button>
      </div>
    </section>

    <div class="planner-layout">
      <div id="progressContainer" class="progress-container" style="display:none;">
        <h3>Your Progress</h3>
        <div class="progress-bar">
          <div id="progressFill" class="progress-fill"></div>
        </div>
        <p id="progressText">0% Complete</p>
      </div>

      <div id="topicDetails" class="topic-details">
        <h3>Current Topic Details</h3>
        <div id="topicContent">
          <div id="currentTopic"></div>
          <div id="topicResources"></div>
          <div class="topic-actions">
            <button onclick="markTopicComplete()" class="ai-button" id="markCompleteBtn" style="display:none;">
              Mark Complete
            </button>
            <button onclick="takeNotes()" class="ai-button secondary" id="notesBtn" style="display:none;">
              Take Notes
            </button>
          </div>
        </div>
      </div>

      <div id="notesPanel" class="notes-panel" style="display:none;">
        <h3>Study Notes</h3>
        <textarea id="notesArea" placeholder="Take notes for your current topic..."></textarea>
        <div class="notes-actions">
          <button onclick="saveNotes()" class="ai-button">Save Notes</button>
          <button onclick="closeNotes()" class="ai-button secondary">Close</button>
        </div>
      </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay" style="display:none;">
      <div class="loader"></div>
      <p>Loading...</p>
    </div>
    </main>

    <script>
      const API = 'http://localhost:4000';
      let currentExam = '';
      let currentTopic = '';

      function showAuthModal(mode) {
        document.getElementById('authModal').style.display = 'flex';
        document.getElementById('fieldName').style.display = mode === 'register' ? 'block' : 'none';
        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active');
      }

      function closeAuthModal() {
        document.getElementById('authModal').style.display = 'none';
      }

      function showAuthTab(mode) {
        showAuthModal(mode);
      }


      async function registerUser(name, email, password) {
        try {
          const res = await fetch(API + '/api/register', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, email, password }) });
          const j = await res.json();
          if (res.ok && j.token) { saveToken(j.token); closeAuthModal(); alert('Registered & logged in'); loadPlannerContent(); } else alert(j.error || JSON.stringify(j));
        } catch (e) { alert('Network error'); }
      }

      function saveToken(token) { localStorage.setItem('edu_token', token); renderAuthState(); }
      function logout() { localStorage.removeItem('edu_token'); renderAuthState(); hideLoggedInContent(); }
      function isAuthed() { return !!localStorage.getItem('edu_token'); }
      function authHeader() { const t = localStorage.getItem('edu_token'); return t ? { 'Authorization': 'Bearer ' + t } : {}; }

      function renderAuthState() {
        const nav = document.getElementById('navActions');
        if (!nav) return;
        nav.innerHTML = '';
        if (isAuthed()) {
          // Get user info from token
          const token = localStorage.getItem('edu_token');
          const payload = JSON.parse(atob(token.split('.')[1]));
          const name = payload.name || 'User';
          const email = payload.email;
          const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();

          // Create profile container
          const profile = document.createElement('div');
          profile.className = 'user-profile';
          profile.onclick = toggleProfileDropdown;
          
          // Add profile picture with initials
          const picture = document.createElement('div');
          picture.className = 'profile-picture';
          picture.textContent = initials;
          
          // Add user info
          const info = document.createElement('div');
          info.className = 'profile-info';
          info.innerHTML = `
            <span class="profile-name">${name}</span>
            <span class="profile-email">${email}</span>
          `;
          
          // Add dropdown menu
          const dropdown = document.createElement('div');
          dropdown.className = 'profile-dropdown';
          dropdown.innerHTML = `
            <a href="#" class="dropdown-item">
              <i class="fas fa-user"></i>
              <span>My Profile</span>
            </a>
            <a href="#" class="dropdown-item">
              <i class="fas fa-cog"></i>
              <span>Settings</span>
            </a>
            <hr style="border:none; border-top:1px solid var(--border-color); margin:0.5rem 0;">
            <a href="#" class="dropdown-item" onclick="logout(); return false;">
              <i class="fas fa-sign-out-alt"></i>
              <span>Logout</span>
            </a>
          `;
          
          profile.appendChild(picture);
          profile.appendChild(info);
          nav.appendChild(profile);
          nav.appendChild(dropdown);
          
          document.getElementById('markCompleteBtn').style.display = 'block';
          document.getElementById('progressContainer').style.display = 'block';
        } else {
          const b = document.createElement('button');
          b.className = 'nav-button';
          nav.appendChild(b);
          hideLoggedInContent();
        }
      }

      function toggleProfileDropdown(e) {
        e.stopPropagation();
        const dropdown = document.querySelector('.profile-dropdown');
        dropdown.classList.toggle('show');
      }

      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        const dropdown = document.querySelector('.profile-dropdown');
        if (dropdown && dropdown.classList.contains('show')) {
          dropdown.classList.remove('show');
        }
      });

      function hideLoggedInContent() {
        document.getElementById('markCompleteBtn').style.display = 'none';
        document.getElementById('progressContainer').style.display = 'none';
      }

      async function markTopicComplete() {
        if (!isAuthed() || !currentExam) return;
        try {
          const res = await fetch(API + '/api/progress/update', {
            method: 'POST',
            headers: Object.assign({'Content-Type': 'application/json'}, authHeader()),
            body: JSON.stringify({ exam: currentExam })
          });
          if (res.ok) {
            loadPlannerContent();
            alert('Progress updated!');
          }
        } catch (e) { console.error(e); }
      }

      function updateProgress(progress) {
        const fill = document.getElementById('progressFill');
        const text = document.getElementById('progressText');
        fill.style.width = progress.percentage + '%';
        text.textContent = `${progress.percentage}% Complete (${progress.completed}/${progress.total} topics)`;
      }

      // Study Timer
      let timerInterval = null;
      let startTime = 0;
      let isTimerRunning = false;

      function toggleTimer() {
        if (isTimerRunning) {
          clearInterval(timerInterval);
          document.getElementById('timerBtn').textContent = 'Start Timer';
          saveStudyTime();
        } else {
          startTime = Date.now() - (parseInt(localStorage.getItem('studyTime_' + currentExam) || '0') * 1000);
          timerInterval = setInterval(updateTimer, 1000);
          document.getElementById('timerBtn').textContent = 'Stop Timer';
        }
        isTimerRunning = !isTimerRunning;
      }

      function updateTimer() {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const hours = Math.floor(elapsed / 3600);
        const minutes = Math.floor((elapsed % 3600) / 60);
        const seconds = elapsed % 60;
        document.getElementById('timerDisplay').textContent = 
          `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      }

      function saveStudyTime() {
        if (!currentExam) return;
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        localStorage.setItem('studyTime_' + currentExam, elapsed.toString());
        
        // Update backend with study time
        if (isAuthed()) {
          fetch(API + '/api/progress/study-time', {
            method: 'POST',
            headers: Object.assign({'Content-Type': 'application/json'}, authHeader()),
            body: JSON.stringify({ exam: currentExam, seconds: elapsed })
          }).catch(console.error);
        }
      }

      // Notes Management
      function takeNotes() {
        document.getElementById('notesPanel').style.display = 'block';
        const savedNotes = localStorage.getItem('notes_' + currentExam + '_' + currentTopic);
        if (savedNotes) document.getElementById('notesArea').value = savedNotes;
      }

      function saveNotes() {
        const notes = document.getElementById('notesArea').value;
        localStorage.setItem('notes_' + currentExam + '_' + currentTopic, notes);
        alert('Notes saved successfully!');
      }

      function closeNotes() {
        document.getElementById('notesPanel').style.display = 'none';
      }

      // Loading State Management
      function showLoading() {
        document.getElementById('loadingOverlay').style.display = 'flex';
      }

      function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
      }

      // Enhanced Content Loading
          
        showLoading();
        try {
          const res = await fetch(API + '/api/progress?exam=' + encodeURIComponent(currentExam), { headers: authHeader() });
          const data = await res.json();
          if (res.ok) {
            updateProgress(data.progress[0] || { percentage: 0, completed: 0, total: 5 });
            await loadTopicDetails(data.progress[0]?.completed || 0);
            // Load saved study time
            const savedTime = localStorage.getItem('studyTime_' + currentExam) || '0';
            startTime = Date.now() - (parseInt(savedTime) * 1000);
            updateTimer();
          }
        } catch (e) {
          console.error(e);
          alert('Failed to load content. Please try again.');
        } finally {
          hideLoading();
        }


      async function loadTopicDetails(completedTopics) {
        const topics = {
          'KCET': ['Physics – Motion and Laws', 'Chemistry – Atomic Structure', 'Math – Trigonometry', 'Biology – Basics', 'Final Revision'],
          'NEET': ['Biology – Human Anatomy', 'Physics – Mechanics', 'Chemistry – Organic', 'Biology – Genetics', 'Final Practice'],
          'JEE': ['Math – Calculus', 'Physics – Dynamics', 'Chemistry – Physical', 'Math – Vectors', 'Mock Tests'],
          'PUC': ['Languages', 'Science Core', 'Mathematics', 'Electives', 'Revision'],
          '10th': ['First Language', 'Science', 'Mathematics', 'Social Science', 'Final Prep']
        };

        currentTopic = topics[currentExam][completedTopics];
        document.getElementById('currentTopic').innerHTML = `
          <h4>${currentTopic}</h4>
          <p>Day ${completedTopics + 1} of your study plan</p>
        `;

        // Show topic resources
        const resourcesHtml = await getTopicResources(currentExam, currentTopic);
        document.getElementById('topicResources').innerHTML = resourcesHtml;

        // Show action buttons
        document.getElementById('markCompleteBtn').style.display = 'block';
        document.getElementById('notesBtn').style.display = 'block';
      }

      async function getTopicResources(exam, topic) {
        // This would typically fetch from the backend, but for now we'll use sample data
        const resources = [
          { title: 'Video Lecture', icon: 'fas fa-video', url: '#' },
          { title: 'Practice Questions', icon: 'fas fa-tasks', url: '#' },
          { title: 'Study Notes', icon: 'fas fa-book', url: '#' }
        ];

        return resources.map(r => `
          <a href="${r.url}" class="resource-link" target="_blank">
            <i class="${r.icon}"></i>
            <span>${r.title}</span>
          </a>
        `).join('');
      }

      // Progress Chart
      async function initProgressChart() {
        const ctx = document.getElementById('progressChart').getContext('2d');
        const data = await fetchProgressData();
        
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.labels,
            datasets: [{
              label: 'Weekly Progress',
              data: data.progress,
              borderColor: 'rgb(37, 99, 235)',
              backgroundColor: 'rgba(37, 99, 235, 0.1)',
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: 'Your Learning Progress'
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                title: {
                  display: true,
                  text: 'Completion %'
                }
              }
            }
          }
        });
      }

      async function fetchProgressData() {
        try {
          const response = await fetch(API + '/api/progress/weekly', {
            headers: authHeader()
          });
          return await response.json();
        } catch (error) {
          console.error('Error fetching progress:', error);
          return { labels: [], progress: [] };
        }
      }

      // Weekly Topic Planning
      async function loadWeeklyPlan() {
        try {
          const response = await fetch(API + '/api/planner/weekly-topics', {
            headers: authHeader()
          });
          const plan = await response.json();
          
          const plannerGrid = document.getElementById('weeklyPlanGrid');
          plannerGrid.innerHTML = plan.weeks.map((week, index) => `
            <div class="week-card">
              <h3>Week ${index + 1}</h3>
              <div class="topics-list">
                ${week.topics.map(topic => `
                  <div class="topic-item ${topic.completed ? 'completed' : ''}">
                    <span>${topic.name}</span>
                    ${topic.completed ? 
                      '<i class="fas fa-check-circle"></i>' : 
                      '<button onclick="startTopic(' + index + ', \'' + topic.id + '\')">Start</button>'
                    }
                  </div>
                `).join('')}
              </div>
              <div class="week-progress">
                <div class="progress-bar" style="width: ${week.progress}%"></div>
                <span>${week.progress}% Complete</span>
              </div>
            </div>
          `).join('');
        } catch (error) {
          console.error('Error loading weekly plan:', error);
        }
      }

      async function startTopic(weekIndex, topicId) {
        try {
          await fetch(API + '/api/planner/start-topic', {
            method: 'POST',
            headers: Object.assign({'Content-Type': 'application/json'}, authHeader()),
            body: JSON.stringify({ weekIndex, topicId })
          });
          loadWeeklyPlan(); // Refresh the plan
        } catch (error) {
          console.error('Error starting topic:', error);
        }
      }

      // Error Handling Enhancement
      window.addEventListener('unhandledrejection', function(event) {
        hideLoading();
        alert('An error occurred. Please check your connection and try again.');
      });

      // Dark Mode Toggle
      function toggleTheme() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
      }

      function updateThemeIcon(theme) {
        const icon = document.getElementById('themeIcon');
        if (icon) {
          icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }
      }

      // Load saved theme
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      updateThemeIcon(savedTheme);

      // Initialize on page load
      renderAuthState();
      if (isAuthed()) {
        loadPlannerContent();
        initProgressChart();
        loadWeeklyPlan();
      }
    </script>
</body>
</html>
