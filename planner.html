<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ECHOES OF EFFORTS - Study Plan</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <nav class="navbar" role="navigation" aria-label="Main navigation">
    <div class="nav-brand">
      <img src="assets/logo.jpg" alt="ECHOES OF EFFORTS Logo" class="nav-logo">
      <span>ECHOES OF EFFORTS</span>
    </div>
    <div class="nav-links">
      <a href="index.html" class="nav-link"><i class="fas fa-home" aria-hidden="true"></i> Home</a>
      <a href="planner.html" class="nav-link active" aria-current="page"><i class="fas fa-calendar-alt" aria-hidden="true"></i> Planner</a>
    </div>
    <div class="nav-actions" id="navActions">
      <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" aria-label="Toggle dark mode">
        <i class="fas fa-moon" id="themeIcon"></i>
      </button>
    </div>
    </div>
  </nav>
        </form>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="planner-header">
    <h1>5-Day Study Planner</h1>
    <p>Organize your preparation with a simple plan</p>
  </header>

  <!-- Main Content -->
  <main>
    <!-- Study Resources -->
    <section class="intro">
      <div class="section-header">
        <h2>Study Schedule</h2>
        <p>Your daily learning path</p>
      </div>
      <table>
        <tr>
          <th>Day</th>
          <th>Subjects & Topics</th>
        </tr>
        <tr>
          <td>Day 1</td>
          <td>Physics – Motion and Laws</td>
        </tr>
        <tr>
          <td>Day 2</td>
          <td>Chemistry – Atomic Structure</td>
        </tr>
        <tr>
          <td>Day 3</td>
          <td>Math – Trigonometry & Algebra</td>
        </tr>
        <tr>
          <td>Day 4</td>
          <td>Biology – Human Anatomy</td>
        </tr>
        <tr>
          <td>Day 5</td>
          <td>Revision + Practice Tests</td>
        </tr>
      </table>
    </section>

    <!-- Progress Overview -->
    <section class="progress-section">
      <div class="section-header">
        <h2>Your Progress Overview</h2>
        <p>Track your learning journey and weekly achievements</p>
      </div>
      <div class="progress-container">
        <div class="chart-container">
          <canvas id="progressChart"></canvas>
        </div>
        <div class="stats-container">
          <div class="stat-card">
            <i class="fas fa-book-open"></i>
            <h3>Topics Completed</h3>
            <p id="topicsCompleted">5</p>
          </div>
          <div class="stat-card">
            <i class="fas fa-chart-line"></i>
            <h3>Weekly Progress</h3>
            <p id="weeklyProgress">15%</p>
          </div>
          <div class="stat-card">
            <i class="fas fa-trophy"></i>
            <h3>Test Score</h3>
            <p id="testScore">15%</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Weekly Test Section -->
    <section class="weekly-test-section">
      <div class="section-header">
        <h2>Weekly Test</h2>
        <p>Test your knowledge with a 20-question assessment</p>
      </div>
      <div class="test-container">
        <div class="exam-select-container">
          <label for="examSelect">Select your exam:</label>
          <select id="examSelect" required>
            <option value="">Choose exam...</option>
            <option value="KCET">KCET</option>
            <option value="NEET">NEET</option>
            <option value="JEE">JEE</option>
            <option value="PUC">PUC</option>
            <option value="10th">10th Board</option>
          </select>
          <button id="startTestBtn" class="ai-button" onclick="generateWeeklyTest()">
            <i class="fas fa-file-alt"></i> Start Weekly Test
          </button>
        </div>
        <div id="testContent" style="display: none;">
          <div id="questions"></div>
          <button id="submitTestBtn" class="ai-button" onclick="submitWeeklyTest()">
            <i class="fas fa-check"></i> Submit Test
          </button>
        </div>
        <div id="testResults" style="display: none;">
          <h3>Test Results</h3>
          <p>Score: <span id="scoreDisplay">0</span>%</p>
          <p>Time Taken: <span id="timeTaken">0:00</span></p>
          <button onclick="closeTestResults()" class="ai-button secondary">
            <i class="fas fa-times"></i> Close
          </button>
        </div>
      </div>
            <p id="avgTestScore">0%</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Weekly Topic Planner -->
    <section class="weekly-planner-section">
      <div class="section-header">
        <h2>Weekly Learning Plan</h2>
        <p>Your personalized study roadmap</p>
      </div>
      <div id="weeklyPlanGrid" class="weekly-plan-grid">
        <!-- Weekly plans will be populated here -->
      </div>
      <!-- Timer removed per request -->
      <!-- Weekly test removed from planner — use Home page Weekly Test instead -->
    </section>

    <!-- Weekly test removed from planner -->

    <div class="planner-layout">
      <div id="progressContainer" class="progress-container" style="display:none;">
        <h3>Your Progress</h3>
        <div class="progress-bar">
          <div id="progressFill" class="progress-fill"></div>
        </div>
        <p id="progressText">0% Complete</p>
      </div>

      <div id="topicDetails" class="topic-details">
        <h3>Current Topic Details</h3>
        <div id="topicContent">
          <div id="currentTopic"></div>
          <div id="topicResources"></div>
          <div class="topic-actions">
            <button onclick="markTopicComplete()" class="ai-button" id="markCompleteBtn" style="display:none;">
              Mark Complete
            </button>
            <button onclick="takeNotes()" class="ai-button secondary" id="notesBtn" style="display:none;">
              Take Notes
            </button>
          </div>
        </div>
      </div>

      <div id="notesPanel" class="notes-panel" style="display:none;">
        <h3>Study Notes</h3>
        <textarea id="notesArea" placeholder="Take notes for your current topic..."></textarea>
        <div class="notes-actions">
          <button onclick="saveNotes()" class="ai-button">Save Notes</button>
          <button onclick="closeNotes()" class="ai-button secondary">Close</button>
        </div>
      </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay" style="display:none;">
      <div class="loader"></div>
      <p>Loading...</p>
    </div>
    </main>

    <script>
      const API = 'http://localhost:4000';
      let currentExam = '';
      let currentTopic = '';

      function showAuthModal(mode) {
        document.getElementById('authModal').style.display = 'flex';
        document.getElementById('fieldName').style.display = mode === 'register' ? 'block' : 'none';
        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active');
      }

      function closeAuthModal() {
        document.getElementById('authModal').style.display = 'none';
      }

      function showAuthTab(mode) {
        showAuthModal(mode);
      }


      async function registerUser(name, email, password) {
        try {
          const res = await fetch(API + '/api/register', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, email, password }) });
          const j = await res.json();
          if (res.ok && j.token) { saveToken(j.token); closeAuthModal(); alert('Registered & logged in'); loadPlannerContent(); } else alert(j.error || JSON.stringify(j));
        } catch (e) { alert('Network error'); }
      }

      function saveToken(token) { localStorage.setItem('edu_token', token); renderAuthState(); }
      function logout() { localStorage.removeItem('edu_token'); renderAuthState(); hideLoggedInContent(); }
      function isAuthed() { return !!localStorage.getItem('edu_token'); }
      function authHeader() { const t = localStorage.getItem('edu_token'); return t ? { 'Authorization': 'Bearer ' + t } : {}; }

      function renderAuthState() {
        const nav = document.getElementById('navActions');
        if (!nav) return;
        nav.innerHTML = '';
        if (isAuthed()) {
          // Get user info from token
          const token = localStorage.getItem('edu_token');
          const payload = JSON.parse(atob(token.split('.')[1]));
          const name = payload.name || 'User';
          const email = payload.email;
          const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();

          // Create profile container
          const profile = document.createElement('div');
          profile.className = 'user-profile';
          profile.onclick = toggleProfileDropdown;
          
          // Add profile picture with initials
          const picture = document.createElement('div');
          picture.className = 'profile-picture';
          picture.textContent = initials;
          
          // Add user info
          const info = document.createElement('div');
          info.className = 'profile-info';
          info.innerHTML = `
            <span class="profile-name">${name}</span>
            <span class="profile-email">${email}</span>
          `;
          
          // Add dropdown menu
          const dropdown = document.createElement('div');
          dropdown.className = 'profile-dropdown';
          dropdown.innerHTML = `
            <a href="#" class="dropdown-item">
              <i class="fas fa-user"></i>
              <span>My Profile</span>
            </a>
            <a href="#" class="dropdown-item">
              <i class="fas fa-cog"></i>
              <span>Settings</span>
            </a>
            <hr style="border:none; border-top:1px solid var(--border-color); margin:0.5rem 0;">
            <a href="#" class="dropdown-item" onclick="logout(); return false;">
              <i class="fas fa-sign-out-alt"></i>
              <span>Logout</span>
            </a>
          `;
          
          profile.appendChild(picture);
          profile.appendChild(info);
          nav.appendChild(profile);
          nav.appendChild(dropdown);
          
          document.getElementById('markCompleteBtn').style.display = 'block';
          document.getElementById('progressContainer').style.display = 'block';
        } else {
          const b = document.createElement('button');
          b.className = 'nav-button';
          nav.appendChild(b);
          hideLoggedInContent();
        }
      }

      function toggleProfileDropdown(e) {
        e.stopPropagation();
        const dropdown = document.querySelector('.profile-dropdown');
        dropdown.classList.toggle('show');
      }

      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        const dropdown = document.querySelector('.profile-dropdown');
        if (dropdown && dropdown.classList.contains('show')) {
          dropdown.classList.remove('show');
        }
      });

      function hideLoggedInContent() {
        document.getElementById('markCompleteBtn').style.display = 'none';
        document.getElementById('progressContainer').style.display = 'none';
      }

      async function markTopicComplete() {
        if (!isAuthed() || !currentExam) return;
        try {
          const res = await fetch(API + '/api/progress/update', {
            method: 'POST',
            headers: Object.assign({'Content-Type': 'application/json'}, authHeader()),
            body: JSON.stringify({ exam: currentExam })
          });
          if (res.ok) {
            loadPlannerContent();
            alert('Progress updated!');
          }
        } catch (e) { console.error(e); }
      }

      function updateProgress(progress) {
        const fill = document.getElementById('progressFill');
        const text = document.getElementById('progressText');
        fill.style.width = progress.percentage + '%';
        text.textContent = `${progress.percentage}% Complete (${progress.completed}/${progress.total} topics)`;
      }

      // Study timer removed (disabled) per user request

      // Notes Management
      function takeNotes() {
        document.getElementById('notesPanel').style.display = 'block';
        const savedNotes = localStorage.getItem('notes_' + currentExam + '_' + currentTopic);
        if (savedNotes) document.getElementById('notesArea').value = savedNotes;
      }

      function saveNotes() {
        const notes = document.getElementById('notesArea').value;
        localStorage.setItem('notes_' + currentExam + '_' + currentTopic, notes);
        alert('Notes saved successfully!');
      }

      function closeNotes() {
        document.getElementById('notesPanel').style.display = 'none';
      }

      // Loading State Management
      function showLoading() {
        document.getElementById('loadingOverlay').style.display = 'flex';
      }

      function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
      }

      // Enhanced Content Loading
          
        showLoading();
        try {
          const res = await fetch(API + '/api/progress?exam=' + encodeURIComponent(currentExam), { headers: authHeader() });
          const data = await res.json();
            if (res.ok) {
            updateProgress(data.progress[0] || { percentage: 0, completed: 0, total: 5 });
            await loadTopicDetails(data.progress[0]?.completed || 0);
          }
        } catch (e) {
          console.error(e);
          alert('Failed to load content. Please try again.');
        } finally {
          hideLoading();
        }


      async function loadTopicDetails(completedTopics) {
        const topics = {
          'KCET': ['Physics – Motion and Laws', 'Chemistry – Atomic Structure', 'Math – Trigonometry', 'Biology – Basics', 'Final Revision'],
          'NEET': ['Biology – Human Anatomy', 'Physics – Mechanics', 'Chemistry – Organic', 'Biology – Genetics', 'Final Practice'],
          'JEE': ['Math – Calculus', 'Physics – Dynamics', 'Chemistry – Physical', 'Math – Vectors', 'Mock Tests'],
          'PUC': ['Languages', 'Science Core', 'Mathematics', 'Electives', 'Revision'],
          '10th': ['First Language', 'Science', 'Mathematics', 'Social Science', 'Final Prep']
        };

        currentTopic = topics[currentExam][completedTopics];
        document.getElementById('currentTopic').innerHTML = `
          <h4>${currentTopic}</h4>
          <p>Day ${completedTopics + 1} of your study plan</p>
        `;

        // Show topic resources
        const resourcesHtml = await getTopicResources(currentExam, currentTopic);
        document.getElementById('topicResources').innerHTML = resourcesHtml;

        // Show action buttons
        document.getElementById('markCompleteBtn').style.display = 'block';
        document.getElementById('notesBtn').style.display = 'block';
      }

      async function getTopicResources(exam, topic) {
        // This would typically fetch from the backend, but for now we'll use sample data
        const resources = [
          { title: 'Video Lecture', icon: 'fas fa-video', url: '#' },
          { title: 'Practice Questions', icon: 'fas fa-tasks', url: '#' },
          { title: 'Study Notes', icon: 'fas fa-book', url: '#' }
        ];

        return resources.map(r => `
          <a href="${r.url}" class="resource-link" target="_blank">
            <i class="${r.icon}"></i>
            <span>${r.title}</span>
          </a>
        `).join('');
      }

      // Weekly test functionality removed from planner (use Home page for tests)

      // Progress Chart
      async function initProgressChart() {
        const ctx = document.getElementById('progressChart').getContext('2d');
        const data = await fetchProgressData();
        
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.labels,
            datasets: [{
              label: 'Weekly Progress',
              data: data.progress,
              borderColor: 'rgb(37, 99, 235)',
              backgroundColor: 'rgba(37, 99, 235, 0.1)',
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: 'Your Learning Progress'
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                title: {
                  display: true,
                  text: 'Completion %'
                }
              }
            }
          }
        });
      }

      async function fetchProgressData() {
        try {
          const response = await fetch(API + '/api/progress/weekly', {
            headers: authHeader()
          });
          return await response.json();
        } catch (error) {
          console.error('Error fetching progress:', error);
          return { labels: [], progress: [] };
        }
      }

      // Weekly Topic Planning
      async function loadWeeklyPlan() {
        try {
          const response = await fetch(API + '/api/planner/weekly-topics', {
            headers: authHeader()
          });
          const plan = await response.json();
          
          const plannerGrid = document.getElementById('weeklyPlanGrid');
          plannerGrid.innerHTML = plan.weeks.map((week, index) => `
            <div class="week-card">
              <h3>Week ${index + 1}</h3>
              <div class="topics-list">
                ${week.topics.map(topic => `
                  <div class="topic-item ${topic.completed ? 'completed' : ''}">
                    <span>${topic.name}</span>
                    ${topic.completed ? 
                      '<i class="fas fa-check-circle"></i>' : 
                      '<button onclick="startTopic(' + index + ', \'' + topic.id + '\')">Start</button>'
                    }
                  </div>
                `).join('')}
              </div>
              <div class="week-progress">
                <div class="progress-bar" style="width: ${week.progress}%"></div>
                <span>${week.progress}% Complete</span>
              </div>
            </div>
          `).join('');
        } catch (error) {
          console.error('Error loading weekly plan:', error);
        }
      }

      async function startTopic(weekIndex, topicId) {
        try {
          await fetch(API + '/api/planner/start-topic', {
            method: 'POST',
            headers: Object.assign({'Content-Type': 'application/json'}, authHeader()),
            body: JSON.stringify({ weekIndex, topicId })
          });
          loadWeeklyPlan(); // Refresh the plan
        } catch (error) {
          console.error('Error starting topic:', error);
        }
      }

      // Error Handling Enhancement
      window.addEventListener('unhandledrejection', function(event) {
        hideLoading();
        alert('An error occurred. Please check your connection and try again.');
      });

      // Dark Mode Toggle
      function toggleTheme() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
      }

      function updateThemeIcon(theme) {
        const icon = document.getElementById('themeIcon');
        if (icon) {
          icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }
      }

      // Load saved theme
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      updateThemeIcon(savedTheme);

      // Report Generation Functions
      async function generateReport() {
        const exam = document.getElementById('examSelect').value;
        const testScores = localStorage.getItem(`testScores_${exam}`) ? 
          JSON.parse(localStorage.getItem(`testScores_${exam}`)) : [];
        const studyTime = localStorage.getItem(`studyTime_${exam}`) || 0;
        const notes = getAllNotes(exam);
        
        // Create report content
        const reportContent = `
          <div class="report-container">
            <h2>Study Progress Report - ${exam}</h2>
            <div class="report-section">
              <h3>Overview</h3>
              <p>Total Study Time: ${formatTime(studyTime)}</p>
              <p>Tests Completed: ${testScores.length}</p>
              <p>Average Score: ${calculateAverageScore(testScores)}%</p>
            </div>
            
            <div class="report-section">
              <h3>Test History</h3>
              ${testScores.map((score, index) => `
                <div class="test-entry">
                  <span>Test ${index + 1}: ${score}%</span>
                </div>
              `).join('') || '<p>No tests taken yet</p>'}
            </div>
            
            <div class="report-section">
              <h3>Study Notes</h3>
              ${notes.map(note => `
                <div class="note-entry">
                  <h4>${note.topic}</h4>
                  <p>${note.content}</p>
                </div>
              `).join('') || '<p>No notes taken yet</p>'}
            </div>
          </div>
        `;

        // Create a popup with the report
        const reportPopup = document.createElement('div');
        reportPopup.className = 'report-popup';
        reportPopup.innerHTML = `
          <div class="report-content">
            <button class="close-report" onclick="this.parentElement.parentElement.remove()">×</button>
            ${reportContent}
            <div class="report-actions">
              <button onclick="printReport()" class="ai-button">
                <i class="fas fa-print"></i> Print Report
              </button>
              <button onclick="downloadReport()" class="ai-button secondary">
                <i class="fas fa-download"></i> Download PDF
              </button>
            </div>
          </div>
        `;

        document.body.appendChild(reportPopup);
      }

      function formatTime(seconds) {
        const hrs = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        return `${hrs} hours, ${mins} minutes`;
      }

      function calculateAverageScore(scores) {
        if (!scores.length) return 0;
        const sum = scores.reduce((a, b) => a + b, 0);
        return Math.round(sum / scores.length);
      }

      function getAllNotes(exam) {
        const notes = [];
        for (let key in localStorage) {
          if (key.startsWith(`notes_${exam}_`)) {
            const topic = key.replace(`notes_${exam}_`, '');
            const content = localStorage.getItem(key);
            notes.push({ topic, content });
          }
        }
        return notes;
      }

      function printReport() {
        window.print();
      }

      function downloadReport() {
        // This is a placeholder - in a real implementation, 
        // you would use a library like jsPDF to generate a PDF
        alert('PDF download feature coming soon!');
      }

      // Weekly Test Functions
      let currentTest = null;
      let startTime = null;

      function getQuestionBank(exam) {
        // Question banks for different exams
        const questionBanks = {
          'KCET': [
            { q: 'What is the SI unit of force?', options: ['Newton', 'Joule', 'Watt', 'Pascal'], a: 0 },
            { q: 'Which element has the atomic number 1?', options: ['Helium', 'Hydrogen', 'Carbon', 'Oxygen'], a: 1 },
            { q: 'What is the value of π (pi) to two decimal places?', options: ['3.14', '3.41', '3.12', '3.16'], a: 0 },
            { q: 'The speed of light is approximately:', options: ['3 × 10⁸ m/s', '3 × 10⁷ m/s', '3 × 10⁶ m/s', '3 × 10⁹ m/s'], a: 0 },
            { q: 'Which state of matter has a definite volume but no definite shape?', options: ['Solid', 'Liquid', 'Gas', 'Plasma'], a: 1 },
            { q: 'The atomic mass of an element is mainly due to:', options: ['Protons and neutrons', 'Electrons and protons', 'Only neutrons', 'Only electrons'], a: 0 },
            { q: 'What is the unit of electric current?', options: ['Volt', 'Ampere', 'Ohm', 'Watt'], a: 1 },
            { q: 'The process of conversion of water vapor to liquid is called:', options: ['Evaporation', 'Condensation', 'Sublimation', 'Freezing'], a: 1 },
            { q: 'Which of these is a vector quantity?', options: ['Mass', 'Time', 'Velocity', 'Temperature'], a: 2 },
            { q: 'The SI unit of pressure is:', options: ['Newton', 'Pascal', 'Joule', 'Watt'], a: 1 },
            { q: 'What is the valency of carbon?', options: ['2', '3', '4', '5'], a: 2 },
            { q: 'The pH of pure water is:', options: ['6', '7', '8', '9'], a: 1 },
            { q: 'Which is the most abundant element in Earth\'s crust?', options: ['Iron', 'Silicon', 'Oxygen', 'Carbon'], a: 2 },
            { q: 'What is the unit of frequency?', options: ['Hertz', 'Meter', 'Second', 'Newton'], a: 0 },
            { q: 'The process of nuclear fusion requires:', options: ['Low temperature', 'High temperature', 'Room temperature', 'Zero temperature'], a: 1 },
            { q: 'Which law states that energy cannot be created or destroyed?', options: ['Newton\'s First Law', 'Law of Conservation of Mass', 'Law of Conservation of Energy', 'Ohm\'s Law'], a: 2 },
            { q: 'What is the charge of an electron?', options: ['Positive', 'Negative', 'Neutral', 'Variable'], a: 1 },
            { q: 'The unit of electric potential is:', options: ['Ampere', 'Volt', 'Ohm', 'Watt'], a: 1 },
            { q: 'Which metal is liquid at room temperature?', options: ['Iron', 'Mercury', 'Copper', 'Gold'], a: 1 },
            { q: 'What is the SI unit of energy?', options: ['Newton', 'Pascal', 'Joule', 'Watt'], a: 2 }
          ],
          'NEET': [
            { q: 'Which organelle is known as the powerhouse of the cell?', options: ['Mitochondria', 'Nucleus', 'Golgi body', 'Ribosome'], a: 0 },
            { q: 'What is the normal blood pressure reading?', options: ['120/80', '140/90', '100/70', '160/100'], a: 0 },
            { q: 'Which blood type is the universal donor?', options: ['A+', 'B+', 'O-', 'AB+'], a: 2 },
            { q: 'The human heart has how many chambers?', options: ['2', '3', '4', '5'], a: 2 },
            { q: 'DNA replication is:', options: ['Conservative', 'Semi-conservative', 'Dispersive', 'None of these'], a: 1 },
            { q: 'Which vitamin is produced when skin is exposed to sunlight?', options: ['Vitamin A', 'Vitamin B', 'Vitamin C', 'Vitamin D'], a: 3 },
            { q: 'The human body has how many pairs of chromosomes?', options: ['22', '23', '24', '25'], a: 1 },
            { q: 'Which organ produces insulin?', options: ['Liver', 'Kidneys', 'Pancreas', 'Spleen'], a: 2 },
            { q: 'Red blood cells live for approximately:', options: ['60 days', '90 days', '120 days', '150 days'], a: 2 },
            { q: 'The pH of blood is normally:', options: ['6.8', '7.0', '7.4', '8.0'], a: 2 },
            { q: 'Which part of the brain controls balance?', options: ['Cerebrum', 'Cerebellum', 'Medulla', 'Hypothalamus'], a: 1 },
            { q: 'The smallest bone in human body is located in:', options: ['Nose', 'Ear', 'Finger', 'Toe'], a: 1 },
            { q: 'Which enzyme is present in saliva?', options: ['Pepsin', 'Amylase', 'Trypsin', 'Lipase'], a: 1 },
            { q: 'The normal body temperature in humans is:', options: ['36°C', '37°C', '38°C', '39°C'], a: 1 },
            { q: 'Which blood cells help in clotting?', options: ['RBC', 'WBC', 'Platelets', 'Plasma'], a: 2 },
            { q: 'The human eye forms which type of image?', options: ['Virtual and erect', 'Real and erect', 'Virtual and inverted', 'Real and inverted'], a: 3 },
            { q: 'Which vitamin helps in blood clotting?', options: ['Vitamin A', 'Vitamin B', 'Vitamin K', 'Vitamin E'], a: 2 },
            { q: 'The number of bones in adult human body is:', options: ['196', '206', '216', '226'], a: 1 },
            { q: 'Which gland is known as master gland?', options: ['Thyroid', 'Pituitary', 'Adrenal', 'Pancreas'], a: 1 },
            { q: 'Which blood group is universal recipient?', options: ['A+', 'B+', 'O+', 'AB+'], a: 3 }
          ],
          'JEE': [
            // Add JEE questions here
            { q: 'What is the dimension of force?', options: ['MLT⁻²', 'MLT⁻¹', 'ML²T⁻²', 'ML²T⁻¹'], a: 0 },
            { q: 'Which quantum number determines the size of an orbital?', options: ['Principal', 'Azimuthal', 'Magnetic', 'Spin'], a: 0 },
            { q: 'The value of acceleration due to gravity at the center of earth is:', options: ['9.8 m/s²', '4.9 m/s²', '0 m/s²', 'Infinity'], a: 2 },
            { q: 'What is the unit of Planck\'s constant?', options: ['Joule-second', 'Joule/second', 'Watt-second', 'Watt/second'], a: 0 }
            // Add more JEE questions as needed
          ],
          'PUC': [
            // Add PUC questions here
            { q: 'What is the molecular formula of glucose?', options: ['C₆H₁₂O₆', 'C₆H₁₀O₅', 'C₆H₆O₆', 'C₆H₈O₆'], a: 0 },
            { q: 'The number of significant figures in 0.00230 is:', options: ['2', '3', '4', '5'], a: 1 },
            { q: 'Which is the strongest electromagnetic force?', options: ['Gravitational', 'Electromagnetic', 'Strong nuclear', 'Weak nuclear'], a: 2 },
            { q: 'The S.I unit of electric charge is:', options: ['Volt', 'Ampere', 'Coulomb', 'Ohm'], a: 2 }
            // Add more PUC questions as needed
          ],
          '10th': [
            // Add 10th board questions here
            { q: 'What is the chemical formula for water?', options: ['H₂O', 'CO₂', 'NaCl', 'H₂SO₄'], a: 0 },
            { q: 'Which is the largest planet in our solar system?', options: ['Mars', 'Jupiter', 'Saturn', 'Neptune'], a: 1 },
            { q: 'What is photosynthesis?', options: ['Respiration process', 'Food making process', 'Decomposition', 'None of these'], a: 1 },
            { q: 'The atomic number of Carbon is:', options: ['5', '6', '7', '8'], a: 1 }
            // Add more 10th questions as needed
          ]
        };
        
        return questionBanks[exam] || [];
      }

      function generateWeeklyTest() {
        const exam = document.getElementById('examSelect').value;
        if (!exam) {
          alert('Please select an exam first');
          return;
        }

        const questionBank = getQuestionBank(exam);
        if (questionBank.length < 20) {
          alert('Not enough questions available for this exam yet. Please try another exam.');
          return;
        }

        // Randomly select 20 questions
        const questions = shuffleArray([...questionBank]).slice(0, 20);
        currentTest = {
          exam: exam,
          questions: questions,
          answers: new Array(20).fill(null),
          startTime: new Date()
        };

        // Display questions
        const questionsHtml = questions.map((q, i) => `
          <div class="question">
            <p><strong>Q${i + 1}.</strong> ${q.q}</p>
            <div class="options">
              ${q.options.map((opt, j) => `
                <label>
                  <input type="radio" name="q${i}" value="${j}" onclick="saveAnswer(${i}, ${j})">
                  ${opt}
                </label>
              `).join('')}
            </div>
          </div>
        `).join('');

        document.getElementById('questions').innerHTML = questionsHtml;
        document.getElementById('testContent').style.display = 'block';
        document.getElementById('startTestBtn').style.display = 'none';
        startTime = new Date();
      }

      function saveAnswer(questionIndex, answerIndex) {
        if (currentTest) {
          currentTest.answers[questionIndex] = answerIndex;
        }
      }

      function submitWeeklyTest() {
        if (!currentTest) {
          alert('No test in progress');
          return;
        }

        // Check if all questions are answered
        const unanswered = currentTest.answers.filter(a => a === null).length;
        if (unanswered > 0) {
          if (!confirm(`You have ${unanswered} unanswered question(s). Do you want to submit anyway?`)) {
            return;
          }
        }

        // Calculate score (each question is worth 5 points)
        const score = currentTest.questions.reduce((total, q, i) => {
          return total + (currentTest.answers[i] === q.a ? 5 : 0);
        }, 0);

        const timeTaken = Math.round((new Date() - currentTest.startTime) / 1000); // in seconds

        // Save score to localStorage
        const examScores = JSON.parse(localStorage.getItem(`testScores_${currentTest.exam}`) || '[]');
        examScores.push(score);
        localStorage.setItem(`testScores_${currentTest.exam}`, JSON.stringify(examScores));

        // Update UI
        document.getElementById('scoreDisplay').textContent = score;
        document.getElementById('timeTaken').textContent = formatTime(timeTaken);
        document.getElementById('testContent').style.display = 'none';
        document.getElementById('testResults').style.display = 'block';
        document.getElementById('testScore').textContent = score + '%';

        // Reset test state
        currentTest = null;
        startTime = null;
      }

      function closeTestResults() {
        document.getElementById('testResults').style.display = 'none';
        document.getElementById('startTestBtn').style.display = 'block';
      }

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      // Initialize on page load
      renderAuthState();
      if (isAuthed()) {
        loadPlannerContent();
        initProgressChart();
        loadWeeklyPlan();
      }
    </script>
</body>
</html>
